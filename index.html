<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Estimador de costos - Semestre en Helsinki</title>
  <!-- TailwindCSS for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js for pie chart rendering -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Utilities for capturing the page and exporting as PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <!-- Header with hero image -->
  <header class="relative">
    <img src="https://duhocinec.com/wp-content/uploads/2024/10/%C4%90%E1%BA%A1i-h%E1%BB%8Dc-KHUD-Haaga-Helia.jpg" alt="Helsinki" class="w-full h-48 object-cover">
    <div class="absolute inset-0 bg-black/40 flex flex-col justify-center items-center text-white">
      <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold drop-shadow-lg">Estimador de costos - Semestre en Helsinki</h1>
      <p class="mt-2 text-sm md:text-base drop-shadow">Diseño inspirado en Haaga‑Helia • Exporta en PDF</p>
    </div>
  </header>

  <main id="app" class="max-w-5xl mx-auto px-4 py-8 space-y-6">
    <!-- Datos de entrada -->
    <section class="bg-white shadow rounded-xl p-4 space-y-4">
      <h2 class="text-xl font-semibold">Datos de entrada</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium">Nombre del estudiante</label>
          <input id="studentName" type="text" class="mt-1 block w-full border rounded p-2" placeholder="Nombre" />
        </div>
        <div>
          <label class="block text-sm font-medium">Número de meses</label>
          <input id="numMonths" type="number" min="1" value="5" class="mt-1 block w-full border rounded p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium">Tipo de cambio EUR→MXN</label>
          <input id="exchangeRate" type="number" min="0" step="0.01" value="20" class="mt-1 block w-full border rounded p-2" />
        </div>
      </div>
    </section>

    <!-- Contenedor para categorías y gráfico -->
    <div class="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0">
      <!-- Categorías de gastos -->
      <!-- On medium screens and above, make the categories section take up one third of the width
           so that the pie chart section can occupy the remaining two thirds. -->
      <section class="bg-white shadow rounded-xl p-4 space-y-4 md:w-1/3">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-semibold">Categorías de gasto</h2>
          <button id="addCategoryBtn" class="bg-blue-500 text-white px-3 py-1 rounded">+ Añadir</button>
        </div>
        <table id="categoriesTable" class="w-full text-left">
          <thead>
            <tr>
              <th class="py-2">Categoría</th>
              <th class="py-2">Monto (EUR/mes)</th>
              <th class="py-2 text-center">&nbsp;</th>
            </tr>
          </thead>
          <tbody id="categoriesBody"></tbody>
        </table>
      </section>
      <!-- Resumen y gráfica -->
      <!-- On medium screens and above, make the summary section take up two thirds of the width
           to give the pie chart more space. -->
      <section class="bg-white shadow rounded-xl p-4 space-y-4 md:w-2/3" id="report">
        <h2 class="text-xl font-semibold">Resumen de la proyección</h2>
        <!--
          In laptops and larger viewports, make the pie chart take up two-thirds
          of the available width while the summary occupies the remaining third.
          On smaller screens the two elements stack naturally.
        -->
        <div class="grid md:grid-cols-3 gap-4">
          <div class="md:col-span-2">
            <canvas id="pieChart"></canvas>
          </div>
          <div class="space-y-2 md:col-span-1">
            <p><strong>Total mensual (EUR):</strong> <span id="totalMonthlyEUR">0</span></p>
            <p><strong>Total semestre (EUR):</strong> <span id="totalSemesterEUR">0</span></p>
            <p><strong>Total semestre (MXN):</strong> <span id="totalSemesterMXN">0</span></p>
          </div>
        </div>
      </section>
    </div>

    <!-- Calculadora de ahorro -->
    <section class="bg-white shadow rounded-xl p-4 space-y-4">
      <h2 class="text-xl font-semibold">Calculadora de ahorro</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium">Ahorro inicial (MXN)</label>
          <input id="initialSavings" type="number" min="0" value="0" class="mt-1 block w-full border rounded p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium">Meses para ahorrar</label>
          <input id="saveMonths" type="number" min="1" value="6" class="mt-1 block w-full border rounded p-2" />
        </div>
        <div></div>
      </div>
      <div class="space-y-2">
        <p><strong>Monto restante por ahorrar (MXN):</strong> <span id="remainingSavings">0</span></p>
        <p><strong>Debe ahorrar por mes (MXN):</strong> <span id="monthlySaving">0</span></p>
        <p><strong>Debe ahorrar por quincena (MXN):</strong> <span id="biweeklySaving">0</span></p>
        <p><strong>Debe ahorrar por semana (MXN):</strong> <span id="weeklySaving">0</span></p>
      </div>
    </section>

    <!-- Botones de acciones -->
    <section class="flex flex-wrap gap-4">
      <button id="pdfBtn" class="bg-green-600 text-white px-4 py-2 rounded flex items-center gap-2">
        Guardar PDF
      </button>
      <a id="emailLink" href="#" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded flex items-center gap-2">
        Redactar correo
      </a>
      <a href="https://www.airbnb.com/s/Pasila--Helsinki--Finland/homes?query=Pasila%2C%20Helsinki%2C%20Finland" target="_blank" class="bg-gray-200 text-gray-800 px-4 py-2 rounded flex items-center gap-2">
        Airbnb
      </a>
      <a href="https://www.booking.com/searchresults.html?ss=Ratapihantie%2013%2C%2000520%20Helsinki%2C%20Finland" target="_blank" class="bg-gray-200 text-gray-800 px-4 py-2 rounded flex items-center gap-2">
        Booking
      </a>
      <a href="https://www.google.com/maps/search/airbnb+near+Ratapihantie+13,+00520+Helsinki" target="_blank" class="bg-gray-200 text-gray-800 px-4 py-2 rounded flex items-center gap-2">
        Google Maps
      </a>
    </section>
  </main>

  <script>
    // Initial categories (EUR per month)
    let categories = [
      { id: 'rent', name: 'Renta (vivienda)', monthly: 700, color: '#00aad4' },
      { id: 'utilities', name: 'Servicios (luz/agua)', monthly: 60, color: '#63c5da' },
      { id: 'food', name: 'Alimentación y despensa', monthly: 280, color: '#004d66' },
      { id: 'transport', name: 'Transporte local', monthly: 55, color: '#67af99' },
      { id: 'insurance', name: 'Seguro médico', monthly: 35, color: '#0079c2' },
      { id: 'permit', name: 'Permiso de residencia/cuotas', monthly: 25, color: '#92d3e5' },
      { id: 'phone', name: 'Teléfono e internet', monthly: 25, color: '#00aacd' },
      { id: 'materials', name: 'Libros y materiales', monthly: 30, color: '#339fb1' },
      { id: 'leisure', name: 'Ocio y varios', monthly: 90, color: '#98c7d8' },
      { id: 'contingency', name: 'Contingencia (colchón)', monthly: 60, color: '#004b57' },
    ];

    // DOM elements
    const categoriesBody = document.getElementById('categoriesBody');
    const totalMonthlyEURSpan = document.getElementById('totalMonthlyEUR');
    const totalSemesterEURSpan = document.getElementById('totalSemesterEUR');
    const totalSemesterMXNSpan = document.getElementById('totalSemesterMXN');
    const numMonthsInput = document.getElementById('numMonths');
    const exchangeRateInput = document.getElementById('exchangeRate');
    const initialSavingsInput = document.getElementById('initialSavings');
    const saveMonthsInput = document.getElementById('saveMonths');
    const remainingSavingsSpan = document.getElementById('remainingSavings');
    const monthlySavingSpan = document.getElementById('monthlySaving');
    const biweeklySavingSpan = document.getElementById('biweeklySaving');
    const weeklySavingSpan = document.getElementById('weeklySaving');
    const emailLink = document.getElementById('emailLink');

    // Chart setup
    const ctx = document.getElementById('pieChart').getContext('2d');
    let pieChart;

    function renderCategories() {
      categoriesBody.innerHTML = '';
      categories.forEach((cat, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 flex items-center gap-2">
            <span class="inline-block w-3 h-3 rounded" style="background:${cat.color}"></span>
            <input type="text" value="${cat.name}" class="w-full border rounded p-1 bg-gray-50" data-index="${idx}" data-field="name">
          </td>
          <td class="py-2">
            <input type="number" min="0" value="${cat.monthly}" class="w-full border rounded p-1 bg-gray-50" data-index="${idx}" data-field="monthly">
          </td>
          <td class="py-2 text-center">
            <button data-index="${idx}" class="text-red-500" aria-label="Eliminar">&times;</button>
          </td>
        `;
        categoriesBody.appendChild(tr);
      });
    }

    function updateChart() {
      const labels = categories.map(c => c.name);
      const data = categories.map(c => c.monthly);
      const colors = categories.map(c => c.color);
      const totalMonthly = data.reduce((a, b) => a + parseFloat(b || 0), 0);
      const months = parseInt(numMonthsInput.value) || 0;
      const rate = parseFloat(exchangeRateInput.value) || 0;
      const totalSemesterEUR = totalMonthly * months;
      const totalSemesterMXN = totalSemesterEUR * rate;

      totalMonthlyEURSpan.textContent = totalMonthly.toFixed(2);
      totalSemesterEURSpan.textContent = totalSemesterEUR.toFixed(2);
      totalSemesterMXNSpan.textContent = totalSemesterMXN.toFixed(2);

      // update savings
      const initialSavings = parseFloat(initialSavingsInput.value) || 0;
      const savingMonths = parseInt(saveMonthsInput.value) || 1;
      const remaining = Math.max(totalSemesterMXN - initialSavings, 0);
      remainingSavingsSpan.textContent = remaining.toFixed(2);
      const monthlySave = remaining / (savingMonths || 1);
      monthlySavingSpan.textContent = monthlySave.toFixed(2);
      biweeklySavingSpan.textContent = (monthlySave / 2).toFixed(2);
      weeklySavingSpan.textContent = (monthlySave / 4.345).toFixed(2);

      // update email link
      const studentName = document.getElementById('studentName').value;
      const subject = encodeURIComponent('Proyección de gastos - Helsinki');
      const body = encodeURIComponent(`Hola,\n\nAquí está la proyección de gastos para ${studentName || 'el estudiante'} en Helsinki.\nTotal mensual: €${totalMonthly.toFixed(2)}\nTotal semestre: €${totalSemesterEUR.toFixed(2)} / MXN$${totalSemesterMXN.toFixed(2)}\n\nSaludos.`);
      emailLink.href = `mailto:?subject=${subject}&body=${body}`;

      // determine if labels should be shown (≥ 1024px)
      const showLabels = window.innerWidth >= 1024;
      const labelOpts = showLabels ? {
        labels: {
          color: '#000',
          font: { size: 12 }
        }
      } : false;

      if (pieChart) pieChart.destroy();
      pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels,
          datasets: [{ data, backgroundColor: colors }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom', labels: { boxWidth: 12 } },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const d = context.dataset.data;
                  const total = d.reduce((a,b) => a + b, 0);
                  const val = context.parsed;
                  const pct = ((val / total) * 100).toFixed(1);
                  return `${context.label}: €${val.toFixed(2)} (${pct}%)`;
                }
              }
            },
            datalabels: false
          }
        }
      });
    }

    // Event listeners
    document.getElementById('addCategoryBtn').addEventListener('click', () => {
      categories.push({ id: Date.now().toString(), name: 'Nueva categoría', monthly: 0, color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0') });
      renderCategories();
      updateChart();
    });

    categoriesBody.addEventListener('input', (e) => {
      const idx = e.target.dataset.index;
      const field = e.target.dataset.field;
      if (idx !== undefined && field) {
        categories[idx][field] = field === 'monthly' ? parseFloat(e.target.value || 0) : e.target.value;
        updateChart();
      }
    });

    categoriesBody.addEventListener('click', (e) => {
      if (e.target.matches('button')) {
        const idx = parseInt(e.target.dataset.index);
        categories.splice(idx, 1);
        renderCategories();
        updateChart();
      }
    });

    [numMonthsInput, exchangeRateInput, initialSavingsInput, saveMonthsInput].forEach(input => {
      input.addEventListener('input', updateChart);
    });

    window.addEventListener('resize', updateChart);

    // PDF generation
    document.getElementById('pdfBtn').addEventListener('click', async () => {
      const { jsPDF } = window.jspdf;
      // capture the entire page (body)
      const canvas = await html2canvas(document.body);
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      // scale image to fit page width
      const ratio = canvas.width / canvas.height;
      const imgWidth = pageWidth;
      const imgHeight = imgWidth / ratio;
      pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
      pdf.save('proyeccion_gastos.pdf');
    });

    // initial render
    renderCategories();
    updateChart();
  </script>
</body>
</html>